/*-------------------------------------------------------------------------
 *
 * data_logger_test.go
 *    Data logger test case
 *
 *
 * Copyright (c) 2021, Alibaba Group Holding Limited
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * IDENTIFICATION
 *           common/log/data_logger_test.go
 *-------------------------------------------------------------------------
 */
package log

import (
	"testing"
	"time"
)

func TestDataLoggerNormal(t *testing.T) {
	d := NewDataLogger("aaa")
	d.PrintData("abcdddfadfafafafafafafafafafafafa1111111")
	d.FlushData()
}

func TestBufferedDataLoggerNormal(t *testing.T) {
	d := NewDataLogger("abcd")
	for i := 0; i < 10; i++ {
		go d.PrintData(`{"L":"INFO","T":"2018-12-23T05:34:35.829+0800","M":"serialize done","size":864,"msg":"4148572847;polardb_mysql;perf;a90a01281.cloud.nu20;11.219.51.30;1545514475;pcm5ey57polardbm44d585486a;3026;0;0;3;0;0;0;0;0;0;0;6290309;0;0;0;0;0;0;0;131072;0;0;0;14;0;0;1;0;0;0;0;0;0;0;0;0;0;0;0;0;148;0;0;0;0;0;0;0;4;0;0;0;0;0;0;0;0;0;0;2944072;0;0;0;0;0;0;0;0;16384;6698;3128392;9;0;0;0;2798717;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;1;0;0;0;0;0;0;0;0;0;0;0;0;1;0;0;0;0;0;0;0;0;0;0;0;0;0;0;6346507;1291686846;0;0;0;0;1372773;0;0;0;1;0;0;0;0;0;0;0;0;10;0;0;0;97;0;0;11339845;0;0;0;0;0;0;0;0;0;457;128;0;0;0;1;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;329583;0;0;0;0;0;0;0;0;0;0;0;56072;0;0;0;0;0;0;0;0;0;0;28606;0;687369;0;0;0;0;0;109930;1373472;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;144796;0;0;0;0;0;0;0;0;1709135;0;0;0;0;353;0;0;0;0;0;0;0;0;0;42687275681;0;0;0;1618030;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;266227;27482;1;0;130719;0;0;0;13585;0;0;106;0;0;0;0;0;0;0;0;752352256;0;0;0;0;0;0;0;0;0;0;0;0;28;0;0;0;0;0;0;0;0;0;0;0;0;0;0;3719831;0;0;0;0;0;1733849;1;0;0;0;0;36;0;0;0;0;0;0;7380628;0;0;0;0;54965;0;0;0;0;0;0;1709135;8;0;0;0;0;0;0;0;0;0;0;0;0;70;0;0;0;0;0;0;1718999;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;73;3557747;0;0;1589569;0;0;0;0;0;0;3557083;0;0;3;0;0;95;0;0;0;0;0;6337111040;0;0;0;0;0;0;2;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;4;0;0;0;0;0;0;5;0;0;0;5783552;353;0;0;0;0;213;0;0;0;209;0;0;0;56256;0;0;1487709148;79;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;14;0;0;0;329583;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;1;0;0;0;0;0;0;0;0;0;1494055690;0;0;0;0;0;0;0;0;0;0;0;0;0;0;112562;0;0;0;0;0;0;0;71;0;0;0;0;0;0;0;0;2;0;0;0;0;0;0;0;0;0;0;459;0;0;0;0;0;0;0;0;657;0;0;0;0;0;0;2;0;2;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;1;0;0;0;0;0;0;0;0;0;0;3517374;0;7380521;0;202963;15043584;0;1;0;0"}`)
	}
	time.Sleep(10 * time.Second)
	d.FlushData()
	teardown("/tmp/data_abcd")
}

func BenchmarkPrintData(b *testing.B) {
	d := NewDataLogger("abc")
	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		d.PrintData(`{"L":"INFO","T":"2018-12-23T05:34:35.829+0800","M":"serialize done","size":864,"msg":"4148572847;polardb_mysql;perf;a90a01281.cloud.nu20;11.219.51.30;1545514475;pcm5ey57polardbm44d585486a;3026;0;0;3;0;0;0;0;0;0;0;6290309;0;0;0;0;0;0;0;131072;0;0;0;14;0;0;1;0;0;0;0;0;0;0;0;0;0;0;0;0;148;0;0;0;0;0;0;0;4;0;0;0;0;0;0;0;0;0;0;2944072;0;0;0;0;0;0;0;0;16384;6698;3128392;9;0;0;0;2798717;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;1;0;0;0;0;0;0;0;0;0;0;0;0;1;0;0;0;0;0;0;0;0;0;0;0;0;0;0;6346507;1291686846;0;0;0;0;1372773;0;0;0;1;0;0;0;0;0;0;0;0;10;0;0;0;97;0;0;11339845;0;0;0;0;0;0;0;0;0;457;128;0;0;0;1;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;329583;0;0;0;0;0;0;0;0;0;0;0;56072;0;0;0;0;0;0;0;0;0;0;28606;0;687369;0;0;0;0;0;109930;1373472;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;144796;0;0;0;0;0;0;0;0;1709135;0;0;0;0;353;0;0;0;0;0;0;0;0;0;42687275681;0;0;0;1618030;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;266227;27482;1;0;130719;0;0;0;13585;0;0;106;0;0;0;0;0;0;0;0;752352256;0;0;0;0;0;0;0;0;0;0;0;0;28;0;0;0;0;0;0;0;0;0;0;0;0;0;0;3719831;0;0;0;0;0;1733849;1;0;0;0;0;36;0;0;0;0;0;0;7380628;0;0;0;0;54965;0;0;0;0;0;0;1709135;8;0;0;0;0;0;0;0;0;0;0;0;0;70;0;0;0;0;0;0;1718999;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;73;3557747;0;0;1589569;0;0;0;0;0;0;3557083;0;0;3;0;0;95;0;0;0;0;0;6337111040;0;0;0;0;0;0;2;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;4;0;0;0;0;0;0;5;0;0;0;5783552;353;0;0;0;0;213;0;0;0;209;0;0;0;56256;0;0;1487709148;79;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;14;0;0;0;329583;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;1;0;0;0;0;0;0;0;0;0;1494055690;0;0;0;0;0;0;0;0;0;0;0;0;0;0;112562;0;0;0;0;0;0;0;71;0;0;0;0;0;0;0;0;2;0;0;0;0;0;0;0;0;0;0;459;0;0;0;0;0;0;0;0;657;0;0;0;0;0;0;2;0;2;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;1;0;0;0;0;0;0;0;0;0;0;3517374;0;7380521;0;202963;15043584;0;1;0;0"}`)
	}
	d.FlushData()
	teardown("/tmp/data_abc")
}
